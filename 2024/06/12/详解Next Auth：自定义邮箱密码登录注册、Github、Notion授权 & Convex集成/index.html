<!DOCTYPE html>
<html lang=ch>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="最近用NextJS框架做全栈项目做的很顺手，现在想给项目加上登录、注册、鉴权拦截、分角色路由控制等功能，并接入Github、Notion等第三方登录。可以使用NextJS官方提供的Auth框架实现。 Intro阅读本篇，你将学会：1、登录、注册等逻辑，和如何接入第三方（以Github、Notion为例）2、建立用户、角色等数据模型，存储用户数据3、公开、私有路由守卫 技术栈 NextJs（前端框架">
<meta property="og:type" content="article">
<meta property="og:title" content="详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成">
<meta property="og:url" content="http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&%20Convex%E9%9B%86%E6%88%90/index.html">
<meta property="og:site_name" content="清川澹如此">
<meta property="og:description" content="最近用NextJS框架做全栈项目做的很顺手，现在想给项目加上登录、注册、鉴权拦截、分角色路由控制等功能，并接入Github、Notion等第三方登录。可以使用NextJS官方提供的Auth框架实现。 Intro阅读本篇，你将学会：1、登录、注册等逻辑，和如何接入第三方（以Github、Notion为例）2、建立用户、角色等数据模型，存储用户数据3、公开、私有路由守卫 技术栈 NextJs（前端框架">
<meta property="og:locale">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d13f0c305c004e24bea0da279ee4ce37~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=388&h=561&s=25327&e=png&b=ffffff">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1a207eee5b14f279f6e7c469af4c482~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=430&h=519&s=23590&e=png&b=ffffff">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fe1d1952c894a0887147f2c2a1cfffb~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1518&h=993&s=139826&e=png&b=ffffff">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6f6072a4ba2443cb684b1939776a5d4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=670&h=467&s=58414&e=png&b=ffffff">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ddb316800dbd49e8adf78d60df2ea3e3~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1127&h=648&s=103126&e=png&b=fefdfb">
<meta property="og:image" content="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1fbdfd00f8094b7bb6f2d522f73c15b1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=601&h=620&s=71973&e=png&b=fdfcfa">
<meta property="og:image" content="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00b68d512f5246f381d18b667779e902~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=988&h=407&s=40786&e=png&b=fefdfb">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b1c6b82d9f4dbe9ab8c1f64750fe8b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=663&h=733&s=70654&e=png&b=fdfcfc">
<meta property="article:published_time" content="2024-06-11T16:00:00.000Z">
<meta property="article:modified_time" content="2024-06-29T15:28:37.000Z">
<meta property="article:author" content="Ygria">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="全栈">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d13f0c305c004e24bea0da279ee4ce37~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=388&h=561&s=25327&e=png&b=ffffff">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于我</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/06/30/2024%E4%B8%8A%E5%8D%8A%E5%B9%B4%20%E4%B9%A6%E5%BD%B1%E9%9F%B3%E7%AC%94%E8%AE%B0/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/05/19/%E7%90%85%E7%90%8A%E5%B1%B1%E4%B8%80%E6%97%A5%E6%B8%B8/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&text=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&is_video=false&description=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成&body=Check out this article: http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&name=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&t=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.1.</span> <span class="toc-text">技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">背景知识学习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.</span> <span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">代码框架搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Credentials"><span class="toc-number">3.</span> <span class="toc-text">Credentials</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">1.基础配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">2.注册页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">3.3.</span> <span class="toc-text">3.用户登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Github-Provider"><span class="toc-number">4.</span> <span class="toc-text">Github Provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%96%B0%E5%BB%BAGithub-Oauth-App"><span class="toc-number">4.1.</span> <span class="toc-text">1. 新建Github Oauth App</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AEGithub-Provider"><span class="toc-number">4.2.</span> <span class="toc-text">2. 配置Github Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A1%B5%E9%9D%A2%E8%A7%A6%E5%8F%91Github%E7%99%BB%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">3.页面触发Github登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Notion-Provider"><span class="toc-number">5.</span> <span class="toc-text">Notion Provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AEPublic-Ingegration"><span class="toc-number">5.1.</span> <span class="toc-text">1. 配置Public Ingegration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AENotion-Provider"><span class="toc-number">5.2.</span> <span class="toc-text">2. 配置Notion Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Notion%E7%99%BB%E5%BD%95"><span class="toc-number">5.3.</span> <span class="toc-text">使用Notion登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Convex-Adapter"><span class="toc-number">6.</span> <span class="toc-text">Convex Adapter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="toc-number">7.</span> <span class="toc-text">其他功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9B%9E%E8%B0%83-callbacks"><span class="toc-number">7.1.</span> <span class="toc-text">1.回调 callbacks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89Session%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.2.</span> <span class="toc-text">2.自定义Session类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BA%8B%E4%BB%B6-events"><span class="toc-number">7.3.</span> <span class="toc-text">3.事件 events</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%A1%B5%E9%9D%A2"><span class="toc-number">7.4.</span> <span class="toc-text">4.页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%99%BB%E5%87%BA"><span class="toc-number">7.5.</span> <span class="toc-text">5.登出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BD%BF%E7%94%A8Session%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">7.6.</span> <span class="toc-text">6.使用Session获取用户信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Ygria</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-06-11T16:00:00.000Z" class="dt-published" itemprop="datePublished">2024-06-12</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%85%A8%E6%A0%88/" rel="tag">全栈</a>, <a class="p-category" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>最近用NextJS框架做全栈项目做的很顺手，现在想给项目加上<strong>登录、注册、鉴权拦截、分角色路由控制</strong>等功能，并接入Github、Notion等第三方登录。<br>可以使用NextJS官方提供的Auth框架实现。</p>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>阅读本篇，你将学会：<br>1、登录、注册等逻辑，和如何接入第三方（以Github、Notion为例）<br>2、建立用户、角色等数据模型，存储用户数据<br>3、公开、私有路由守卫</p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><ul>
<li>NextJs（前端框架）  v14.2.3</li>
<li>React（前端框架）  18</li>
<li>NextAuth（鉴权框架） v5.0.0-beta.18</li>
<li>Convex （后端接口 + ORM）</li>
</ul>
<h2 id="背景知识学习"><a href="#背景知识学习" class="headerlink" title="背景知识学习"></a>背景知识学习</h2><p>在开始实现之前，需要知道NextJS中服务端组件和客户端组件的概念。<br>NextJS中使用”use client“和”use server“标识服务端和客户端组件，客户端运行在浏览器中，服务端运行在服务器端。<strong>不标识时，默认为服务端组件。</strong><br>服务端组件用于异步请求等，负责与服务端交互、请求数据等，客户端组件主要用于和用户交互。React的钩子也有明确的区分，比如useEffect等钩子只能在客户端组件中使用。</p>
<h1 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h1><h2 id="代码框架搭建"><a href="#代码框架搭建" class="headerlink" title="代码框架搭建"></a>代码框架搭建</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-next-app@latest  </span><br></pre></td></tr></table></figure>

<p>使用<strong>NextAuth（v5版本）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install next-auth@beta  </span><br></pre></td></tr></table></figure>

<p>开始之前，需要在环境变量文件<code>.env.local</code>中配置变量</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AUTH_SECRET=**********************</span><br></pre></td></tr></table></figure>

<h1 id="Credentials"><a href="#Credentials" class="headerlink" title="Credentials"></a>Credentials</h1><p>我们首先实现一个简单的账号密码注册、登录、登出。<br>参考： <a target="_blank" rel="noopener" href="https://authjs.dev/getting-started/authentication/credentials#credentials-provider">Credentials</a></p>
<h2 id="1-基础配置"><a href="#1-基础配置" class="headerlink" title="1.基础配置"></a>1.基础配置</h2><p>在项目根目录下，新建<code>auth.js</code>文件，并写入以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">NextAuth</span> <span class="keyword">from</span> <span class="string">&quot;next-auth&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Credentials</span> <span class="keyword">from</span> <span class="string">&quot;next-auth/providers/credentials&quot;</span></span><br><span class="line"><span class="comment">// Your own logic for dealing with plaintext password strings; be careful!</span></span><br><span class="line"><span class="keyword">import</span> &#123; saltAndHashPassword &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/password&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; handlers, signIn, signOut, auth &#125; = <span class="title class_">NextAuth</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title class_">Credentials</span>(&#123;</span><br><span class="line">      <span class="attr">authorize</span>: <span class="keyword">async</span> (credentials) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> user = <span class="literal">null</span></span><br><span class="line"> </span><br><span class="line">       <span class="comment">// logic to salt and hash password</span></span><br><span class="line">        <span class="keyword">const</span> pwHash = <span class="title function_">saltAndHashPassword</span>(credentials.<span class="property">password</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// logic to verify if user exists</span></span><br><span class="line">        user = <span class="keyword">await</span> <span class="title function_">getUserFromDb</span>(credentials.<span class="property">email</span>, pwHash)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">          <span class="comment">// No user found, so this is their first attempt to login</span></span><br><span class="line">          <span class="comment">// meaning this is also the place you could do registration</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;User not found.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// return user object with the their profile data</span></span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在根目录下，新建文件<code>middleware.ts</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">NextAuth</span> <span class="keyword">from</span> <span class="string">&#x27;next-auth&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line"><span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span>,</span><br><span class="line">apiAuthPrefix,</span><br><span class="line">authRoutes,</span><br><span class="line">publicRoutes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/routes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; auth &#125; <span class="keyword">from</span> <span class="string">&#x27;./auth&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">auth</span>(<span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; nextUrl &#125; = req;</span><br><span class="line"><span class="comment">// console.log(&quot;NEXT URL&quot; + nextUrl.pathname)</span></span><br><span class="line"><span class="keyword">const</span> isLoggedIn = !!req.<span class="property">auth</span>;</span><br><span class="line"><span class="keyword">const</span> isApiAuthRoute = nextUrl.<span class="property">pathname</span>.<span class="title function_">startsWith</span>(apiAuthPrefix);</span><br><span class="line"><span class="keyword">const</span> isPublicRoutes = publicRoutes.<span class="title function_">includes</span>(nextUrl.<span class="property">pathname</span>);</span><br><span class="line"><span class="keyword">const</span> isAuthRoute = authRoutes.<span class="title function_">includes</span>(nextUrl.<span class="property">pathname</span>);</span><br><span class="line"><span class="keyword">if</span> (isApiAuthRoute) &#123;</span><br><span class="line"><span class="comment">// DO NOTHING!</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isAuthRoute) &#123;</span><br><span class="line"><span class="keyword">if</span> (isLoggedIn) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span>, nextUrl))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isLoggedIn &amp;&amp; !isPublicRoutes) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Response</span>.<span class="title function_">redirect</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;/auth/login&quot;</span>, nextUrl))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// invoke the middle ware!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> config = &#123;</span><br><span class="line"></span><br><span class="line"><span class="attr">matcher</span>: [<span class="string">&quot;/((?!.+\\.[\\w]+$|_next).*)&quot;</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;/(api|trpc)(.*)&quot;</span>],</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>routes.ts</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Public Routes</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> publicRoutes = [</span><br><span class="line"><span class="string">&quot;/&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment">// redirect logged in users to /settings</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> authRoutes = [</span><br><span class="line"><span class="string">&quot;/auth/login&quot;</span>,</span><br><span class="line"><span class="string">&quot;/auth/register&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> apiAuthPrefix = <span class="string">&quot;/api/auth&quot;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span> = <span class="string">&quot;/dashboard&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>middleware.ts</code>为保留文件名，其中<code>config</code>变量定义了触发中间件方法的匹配规则。该文件中，定义了<code>auth</code>方法的过滤器。<br>在<code>route.ts</code>中定义公开路径、用于鉴权的路径、鉴权接口前缀及默认重定向地址。<br>在过滤方法中，返回null说明无需执行权限检查。对于公开路径及鉴权接口，无需登录即可访问。登录后，再访问注册和登录页面，会自动重定向到<code>DEFAULT_LOGIN_REDIRECT</code>定义的<code>/dashboard</code>路由中。<br>配置NextAuth路由：<br><code>api/auth/[...nextauth]/route.ts</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; handlers &#125; <span class="keyword">from</span> <span class="string">&quot;@/auth&quot;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; <span class="variable constant_">GET</span>, <span class="variable constant_">POST</span> &#125; = handlers</span><br></pre></td></tr></table></figure>

<h2 id="2-注册页面"><a href="#2-注册页面" class="headerlink" title="2.注册页面"></a>2.注册页面</h2><p>实现形如下图的注册页面，核心为可提交的表单，包含name、email、password等字段。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d13f0c305c004e24bea0da279ee4ce37~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=388&h=561&s=25327&e=png&b=ffffff" alt="image.png"></p>
<p>使用zod进行字段的合法性校验。在<code>schemas/index.ts</code>中，定义注册使用的schema：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">RegisterSchema</span> = z.<span class="title function_">object</span>(&#123;</span><br><span class="line">    <span class="attr">email</span>: z.<span class="title function_">string</span>().<span class="title function_">email</span>(&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Email is Required.&quot;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">password</span>: z.<span class="title function_">string</span>().<span class="title function_">min</span>(<span class="number">6</span>,&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Minimum 6 characters required&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">name</span>: z.<span class="title function_">string</span>().<span class="title function_">min</span>(<span class="number">1</span>,&#123;</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Name is Required&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>注册页面代码（部分）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useState, useTransition &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; cn &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/utils&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; zodResolver &#125; <span class="keyword">from</span> <span class="string">&quot;@hookform/resolvers/zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; register &#125; <span class="keyword">from</span> <span class="string">&quot;@/actions/register&quot;</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RegisterFormProps</span> <span class="keyword">extends</span> <span class="title class_">React</span>.<span class="title class_">HTMLAttributes</span>&lt;<span class="title class_">HTMLDivElement</span>&gt; &#123; &#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RegisterForm</span>(<span class="params">&#123; className, ...props &#125;: RegisterFormProps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isPending, startTransition] = <span class="title function_">useTransition</span>();</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [success, setSuccess] = useState&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> form = useForm&lt;z.<span class="property">infer</span>&lt;<span class="keyword">typeof</span> <span class="title class_">RegisterSchema</span>&gt;&gt;(&#123;</span><br><span class="line">    <span class="attr">resolver</span>: <span class="title function_">zodResolver</span>(<span class="title class_">RegisterSchema</span>),</span><br><span class="line">    <span class="attr">defaultValues</span>: &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">email</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">password</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onSubmit</span>(<span class="params">values: z.infer&lt;<span class="keyword">typeof</span> RegisterSchema&gt;</span>) &#123;</span><br><span class="line">    <span class="title function_">setError</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="title function_">setSuccess</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="title function_">startTransition</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">register</span>(values).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setError</span>(data.<span class="property">error</span>)</span><br><span class="line">        <span class="title function_">setSuccess</span>(data.<span class="property">success</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;cn(</span>&quot;<span class="attr">grid</span> <span class="attr">gap-6</span>&quot;, <span class="attr">className</span>)&#125; &#123;<span class="attr">...props</span>&#125;&gt;</span>  </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;form.handleSubmit(onSubmit)&#125;</span> <span class="attr">className</span>=<span class="string">&quot;space-y-6&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          // form field inputs</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">className</span>=<span class="string">&quot;w-full&quot;</span> <span class="attr">disabled</span>=<span class="string">&#123;isPending&#125;</span>&gt;</span>Create an account<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>actions/register.ts</code> 处理注册用户入库：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RegisterSchema</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/schemas&quot;</span>;</span><br><span class="line"><span class="keyword">import</span>  bcrypt  <span class="keyword">from</span> <span class="string">&quot;bcryptjs&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; api &#125; <span class="keyword">from</span> <span class="string">&quot;@/convex/_generated/api&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fetchMutation, fetchQuery &#125; <span class="keyword">from</span> <span class="string">&quot;convex/nextjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getUserByEmail &#125; <span class="keyword">from</span> <span class="string">&quot;@/data/user&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">register</span> = <span class="keyword">async</span> (<span class="params">values: z.infer&lt;<span class="keyword">typeof</span> RegisterSchema&gt;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> validatedFields = <span class="title class_">RegisterSchema</span>.<span class="title function_">safeParse</span>(values);</span><br><span class="line">    <span class="keyword">if</span> (!validatedFields.<span class="property">success</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">error</span>: <span class="string">&quot;Invalid fields!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; email, password, name &#125; = validatedFields.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">const</span> hasedPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">const</span> existingUser = <span class="keyword">await</span> <span class="title function_">getUserByEmail</span>(email)</span><br><span class="line">    <span class="keyword">if</span> (existingUser) &#123;</span><br><span class="line">        <span class="string">``</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">error</span>: <span class="string">&quot;Email already in use!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">fetchMutation</span>(api.<span class="property">user</span>.<span class="property">create</span>, &#123;</span><br><span class="line">        name,</span><br><span class="line">        email,</span><br><span class="line">        <span class="attr">password</span>: hasedPassword</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// TODO : Send verification token email</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment">// error: &quot;Invalid fields!&quot;,</span></span><br><span class="line">        <span class="attr">success</span>: <span class="string">&quot;User Created&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户在注册页面填写名称、邮箱、密码后，点击submit按钮，客户端组件调用了服务组件方法，先查询邮箱是否被占用，未被占用，将明文密码使用<code>bcryptjs</code>加密后，存入数据库中。</p>
<h2 id="3-用户登录"><a href="#3-用户登录" class="headerlink" title="3.用户登录"></a>3.用户登录</h2><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1a207eee5b14f279f6e7c469af4c482~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=430&h=519&s=23590&e=png&b=ffffff" alt="image.png"><br>同样使用zod进行登录表单的字段的合法性校验。在<code>schemas/index.ts</code>中，定义登录使用的schema：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LoginSchema</span> = z.<span class="title function_">object</span>(&#123;</span><br><span class="line">    <span class="attr">email</span>: z.<span class="title function_">string</span>().<span class="title function_">email</span>(),</span><br><span class="line">    <span class="attr">password</span>: z.<span class="title function_">string</span>().<span class="title function_">min</span>(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：不应限制用户填入密码规则。虽然注册时限定了用户填写的密码至少6位，但系统的密码规则有可能变更。</p>
</blockquote>
<p>登录页面代码（部分）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useState, useTransition &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; cn &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/utils&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useForm &#125; <span class="keyword">from</span> <span class="string">&quot;react-hook-form&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginSchema</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/schemas&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; zodResolver &#125; <span class="keyword">from</span> <span class="string">&quot;@hookform/resolvers/zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; login &#125; <span class="keyword">from</span> <span class="string">&quot;@/actions/login&quot;</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">LoginFormProps</span> <span class="keyword">extends</span> <span class="title class_">React</span>.<span class="title class_">HTMLAttributes</span>&lt;<span class="title class_">HTMLDivElement</span>&gt; &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">LoginForm</span>(<span class="params">&#123; className, ...props &#125;: LoginFormProps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isPending, startTransition] = <span class="title function_">useTransition</span>();</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = useState&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [success, setSuccess] = useState&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> form = useForm&lt;z.<span class="property">infer</span>&lt;<span class="keyword">typeof</span> <span class="title class_">LoginSchema</span>&gt;&gt;(&#123;</span><br><span class="line">    <span class="attr">resolver</span>: <span class="title function_">zodResolver</span>(<span class="title class_">LoginSchema</span>),</span><br><span class="line">    <span class="attr">defaultValues</span>: &#123;</span><br><span class="line">      <span class="attr">email</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">password</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onSubmit</span>(<span class="params">values: z.infer&lt;<span class="keyword">typeof</span> LoginSchema&gt;</span>) &#123;</span><br><span class="line">    <span class="title function_">setError</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="title function_">setSuccess</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="title function_">startTransition</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">login</span>(values).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">error</span>) &#123;</span><br><span class="line">          <span class="title function_">setError</span>(data.<span class="property">error</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;cn(</span>&quot;<span class="attr">grid</span> <span class="attr">gap-6</span>&quot;, <span class="attr">className</span>)&#125; &#123;<span class="attr">...props</span>&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;form.handleSubmit(onSubmit)&#125;</span> <span class="attr">className</span>=<span class="string">&quot;space-y-6&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">className</span>=<span class="string">&quot;w-full&quot;</span> <span class="attr">disabled</span>=<span class="string">&#123;isPending&#125;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>actions/login.ts</code> 登录操作：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; signIn &#125; <span class="keyword">from</span> <span class="string">&quot;@/auth&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> z <span class="keyword">from</span> <span class="string">&quot;zod&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginSchema</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/schemas&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/routes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthError</span> &#125; <span class="keyword">from</span> <span class="string">&quot;next-auth&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">values: z.infer&lt;<span class="keyword">typeof</span> LoginSchema&gt;</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> validatedFields = <span class="title class_">LoginSchema</span>.<span class="title function_">safeParse</span>(values);</span><br><span class="line">    <span class="keyword">if</span> (!validatedFields.<span class="property">success</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">error</span>: <span class="string">&quot;Invalid fields!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; email, password &#125; = validatedFields.<span class="property">data</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;EMAIL!&quot;</span> + email + <span class="string">&quot;PASSWORD!&quot;</span> + password)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">signIn</span>(<span class="string">&quot;credentials&quot;</span>, &#123;</span><br><span class="line">            email, password,</span><br><span class="line">            <span class="comment">// redirect: true,</span></span><br><span class="line">            <span class="attr">redirectTo</span>: <span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span></span><br><span class="line">        &#125;,)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> <span class="title class_">AuthError</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (error.<span class="property">type</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;CredentialsSignin&quot;</span>:</span><br><span class="line">                    <span class="keyword">return</span> &#123; <span class="attr">error</span>: <span class="string">&quot;Invalid Credentials!&quot;</span> &#125;</span><br><span class="line">                <span class="attr">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> &#123; <span class="attr">error</span>: <span class="string">&quot;Something went wrong!&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，该操作从<code>@/auth</code>中导入了SignIn方法，第一个参数指定了Provider，实际的授权在Provider定义的<code>authorize</code>方法中完成：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bcrypt <span class="keyword">from</span> <span class="string">&quot;bcryptjs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NextAuth</span>, &#123; <span class="keyword">type</span> <span class="title class_">DefaultSession</span> &#125; <span class="keyword">from</span> <span class="string">&quot;next-auth&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Credentials</span> <span class="keyword">from</span> <span class="string">&quot;next-auth/providers/credentials&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LoginSchema</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./schemas&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; auth, handlers, signIn, signOut &#125; = <span class="title class_">NextAuth</span>(&#123;</span><br><span class="line">    <span class="attr">providers</span>: [</span><br><span class="line">        <span class="title class_">Credentials</span>(&#123;</span><br><span class="line">            <span class="keyword">async</span> <span class="title function_">authorize</span>(<span class="params">credentials</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> validatedFields = <span class="title class_">LoginSchema</span>.<span class="title function_">safeParse</span>(credentials);</span><br><span class="line">                <span class="keyword">if</span> (validatedFields.<span class="property">success</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> &#123; email, password &#125; = validatedFields.<span class="property">data</span>;</span><br><span class="line">                    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">getUserByEmailFromDB</span>(email);</span><br><span class="line">                    <span class="keyword">if</span> (!user || !user.<span class="property">password</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">const</span> passwordsMatch = <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(password, user.<span class="property">password</span>);</span><br><span class="line">                    <span class="keyword">if</span> (passwordsMatch) &#123;</span><br><span class="line">                        <span class="keyword">return</span> &#123;</span><br><span class="line">                            ...user,</span><br><span class="line">                            <span class="attr">id</span>: user.<span class="property">_id</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;,</span><br><span class="line"></span><br><span class="line">        &#125;),]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，由于密码在注册时使用了<code>bcryptjs</code>加密，所以比较时也要使用<code>bcryptjs</code>提供的match方法。至此，使用邮箱和密码登录注册的简单逻辑已完成。</p>
<h1 id="Github-Provider"><a href="#Github-Provider" class="headerlink" title="Github Provider"></a>Github Provider</h1><h2 id="1-新建Github-Oauth-App"><a href="#1-新建Github-Oauth-App" class="headerlink" title="1. 新建Github Oauth App"></a>1. 新建Github Oauth App</h2><p>在<code>https://github.com/settings/developers</code>下，新建Oauth Apps</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fe1d1952c894a0887147f2c2a1cfffb~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1518&h=993&s=139826&e=png&b=ffffff" alt="image.png"></p>
<blockquote>
<p>Callback url很重要，一定是你的站点host+port，后面配置为Next Auth默认回跳地址<code>/api/auth/callback/github</code>。（我当前配置为开发用，生产时需要改为线上地址。）</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6f6072a4ba2443cb684b1939776a5d4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=670&h=467&s=58414&e=png&b=ffffff" alt="image.png"><br>配置完成后，将Client ID 和Client Secret粘贴到配置文件中。<br><code>.env.local</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GITHUB_CLIENT_ID=****</span><br><span class="line">GITHUB_CLIENT_SECRET=****</span><br></pre></td></tr></table></figure>

<h2 id="2-配置Github-Provider"><a href="#2-配置Github-Provider" class="headerlink" title="2. 配置Github Provider"></a>2. 配置Github Provider</h2><p>在<code>auth.ts</code>的Providers数组中，加入：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">GitHub</span>(&#123;</span><br><span class="line">  <span class="attr">clientId</span>: process.<span class="property">env</span>.<span class="property">GITHUB_CLIENT_ID</span>,</span><br><span class="line">  <span class="attr">clientSecret</span>: process.<span class="property">env</span>.<span class="property">GITHUB_CLIENT_SECRET</span>,</span><br><span class="line">  <span class="attr">allowDangerousEmailAccountLinking</span>: <span class="literal">true</span></span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure>
<p><code>allowDangerousEmailAccountLinking</code>是允许使用同一邮箱的Github、Notion账号互联。若不配置该属性，使用同一邮箱注册的Notion和Github（或其他第三方）登录将被拦截。当使用的Providers来自于不可靠的OAuth App厂商，须谨慎使用该属性。</p>
<h2 id="3-页面触发Github登录"><a href="#3-页面触发Github登录" class="headerlink" title="3.页面触发Github登录"></a>3.页面触发Github登录</h2><p><code>social.tsx</code><br>从<code>@/auth.ts</code>中导入登录方法，并在点击按钮时触发即可。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">FaGithub</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-icons/fa&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SiNotion</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-icons/si&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/components/ui/button&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; signIn &#125; <span class="keyword">from</span> <span class="string">&quot;next-auth/react&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/routes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">Social</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onClick</span> = (<span class="params">provider: <span class="string">&quot;github&quot;</span> | <span class="string">&quot;notion&quot;</span></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">signIn</span>(provider, &#123;</span><br><span class="line">            <span class="attr">callbackUrl</span>: <span class="variable constant_">DEFAULT_LOGIN_REDIRECT</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex items-center w-full gap-x-2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">size</span>=<span class="string">&quot;lg&quot;</span> <span class="attr">className</span>=<span class="string">&quot;w-full&quot;</span> <span class="attr">variant</span>=<span class="string">&quot;outline&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> onClick(&quot;github&quot;)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">FaGithub</span> <span class="attr">className</span>=<span class="string">&quot;h-5 w-5&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">FaGithub</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">size</span>=<span class="string">&quot;lg&quot;</span> <span class="attr">className</span>=<span class="string">&quot;w-full&quot;</span> <span class="attr">variant</span>=<span class="string">&quot;outline&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> onClick(&quot;notion&quot;)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SiNotion</span> <span class="attr">className</span>=<span class="string">&quot;h-5 w-5&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首次点击时，会跳转到Github询问是否授权。之后会直接点击后跳转鉴权并登录。</p>
<h1 id="Notion-Provider"><a href="#Notion-Provider" class="headerlink" title="Notion Provider"></a>Notion Provider</h1><p>Notion登录的配置方法与Github非常类似。</p>
<h2 id="1-配置Public-Ingegration"><a href="#1-配置Public-Ingegration" class="headerlink" title="1. 配置Public Ingegration"></a>1. 配置Public Ingegration</h2><p>前往<a target="_blank" rel="noopener" href="https://www.notion.so/my-integrations">https://www.notion.so/my-integrations</a> ，新建一个Integration，并设置为公有</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ddb316800dbd49e8adf78d60df2ea3e3~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1127&h=648&s=103126&e=png&b=fefdfb" alt="image.png"><br>需将回调地址配置为<code>/api/auth/callback/notion</code></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1fbdfd00f8094b7bb6f2d522f73c15b1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=601&h=620&s=71973&e=png&b=fdfcfa" alt="image.png"></p>
<p>生成并复制Secrets：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00b68d512f5246f381d18b667779e902~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=988&h=407&s=40786&e=png&b=fefdfb" alt="image.png"></p>
<p>将Client ID和Secret复制到配置文件中。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AUTH_NOTION_ID=<span class="string">&quot;&quot;</span></span><br><span class="line">AUTH_NOTION_SECRET=<span class="string">&quot;&quot;</span></span><br><span class="line">AUTH_NOTION_REDIRECT_URI=<span class="string">&quot;http://localhost:3001/api/auth/callback/notion&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-配置Notion-Provider"><a href="#2-配置Notion-Provider" class="headerlink" title="2. 配置Notion Provider"></a>2. 配置Notion Provider</h2><p>在<code>auth.ts</code>的Providers数组中，加入：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Notion</span>(&#123;</span><br><span class="line">     <span class="attr">clientId</span>: process.<span class="property">env</span>.<span class="property">AUTH_NOTION_ID</span>,</span><br><span class="line">     <span class="attr">clientSecret</span>: process.<span class="property">env</span>.<span class="property">AUTH_NOTION_SECRET</span>,</span><br><span class="line">     <span class="attr">redirectUri</span>: process.<span class="property">env</span>.<span class="property">AUTH_NOTION_REDIRECT_URI</span>,</span><br><span class="line">     <span class="attr">allowDangerousEmailAccountLinking</span>: <span class="literal">true</span></span><br><span class="line">   &#125;),</span><br></pre></td></tr></table></figure>
<p>需传入redirectUri（该uri必须配置到上一步的Ingegration中）</p>
<h2 id="使用Notion登录"><a href="#使用Notion登录" class="headerlink" title="使用Notion登录"></a>使用Notion登录</h2><p>登录的触发方法与Github相同，不赘述。点击登录时，会多出一步，可以选择授权访问的page范围。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b1c6b82d9f4dbe9ab8c1f64750fe8b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=663&h=733&s=70654&e=png&b=fdfcfc" alt="image.png"></p>
<h1 id="Convex-Adapter"><a href="#Convex-Adapter" class="headerlink" title="Convex Adapter"></a>Convex Adapter</h1><p>参考文档：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://authjs.dev/guides/creating-a-database-adapter">Auth.js | Creating A Database Adapter</a></li>
<li><a target="_blank" rel="noopener" href="https://stack.convex.dev/nextauth-adapter">https://stack.convex.dev/nextauth-adapter</a></li>
</ol>
<p>本应用使用了Convex作为后台API提供，所以需要实现Convex Adapter。按<a target="_blank" rel="noopener" href="https://stack.convex.dev/nextauth-adapter">https://stack.convex.dev/nextauth-adapter</a> 步骤操作即可。</p>
<p><code>auth.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">NextAuth</span> <span class="keyword">from</span> <span class="string">&quot;next-auth&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConvexAdapter</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/app/ConvexAdapter&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> &#123; handlers, auth, signIn, signOut &#125; = <span class="title class_">NextAuth</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [],</span><br><span class="line">  <span class="attr">adapter</span>: <span class="title class_">ConvexAdapter</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意避坑！！！！</strong></p>
<p>这里遇到了一个坑，配置了Convex Adapter后，使用邮箱密码再也无法登陆。经过调试发现是通过Credentials登录时，没有调用createSession方法，session没有创建。在Github上搜索后，发现有人遇到类似问题：<a target="_blank" rel="noopener" href="https://github.com/nextauthjs/next-auth/issues/3970">https://github.com/nextauthjs/next-auth/issues/3970</a></p>
</blockquote>
<p><strong>在auth.ts中增加如下配置：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">session</span>: &#123;</span><br><span class="line">   <span class="comment">// Set to jwt in order to CredentialsProvider works properly</span></span><br><span class="line">   <span class="attr">strategy</span>: <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>即可解决问题！！（卡了好久，真的有点坑……教训就是遇到问题先上github搜搜issue，我一直试图手动自己往数据库塞入一个session未果……）</p>
<h1 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h1><h2 id="1-回调-callbacks"><a href="#1-回调-callbacks" class="headerlink" title="1.回调 callbacks"></a>1.回调 callbacks</h2><p>在回调中，可以向session加入自定义属性</p>
<p><code>auth.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">callbacks</span>: &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">signIn</span>(<span class="params">&#123; user &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(&quot;AFTER SIGN IN !&quot; + JSON.stringify(user));</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">jwt</span>(<span class="params">&#123; token, user, account, profile, isNewUser, session &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">      token.<span class="property">id</span> = user.<span class="property">id</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> notionAccount = <span class="keyword">await</span> <span class="title function_">getNotionAccount</span>(token.<span class="property">id</span>!! <span class="keyword">as</span> <span class="title class_">Id</span>&lt;<span class="string">&quot;users&quot;</span>&gt;)</span><br><span class="line">    <span class="keyword">if</span> (notionAccount) &#123;</span><br><span class="line">      token.<span class="property">notion_token</span> = notionAccount.<span class="property">access_token</span>;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">session</span>(<span class="params">&#123; token, session &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (token.<span class="property">sub</span> &amp;&amp; session.<span class="property">user</span>) &#123;</span><br><span class="line">      session.<span class="property">user</span>.<span class="property">id</span> = token.<span class="property">sub</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (token.<span class="property">notion_token</span> &amp;&amp; session.<span class="property">user</span>) &#123;</span><br><span class="line">      session.<span class="property">user</span>.<span class="property">notion_token</span> = token.<span class="property">notion_token</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>执行顺序： signIn &#x3D;&gt; jwt &#x3D;&gt; session</p>
<p>可在session中读到在jwt方法返回的token值，可将需要的属性放到session中，如角色、权限等。此处我将Notion的secret放到session中，以便业务代码中取用。</p>
<h2 id="2-自定义Session类型"><a href="#2-自定义Session类型" class="headerlink" title="2.自定义Session类型"></a>2.自定义Session类型</h2><p>在auth.ts中加入如下代码，可解决自定义session中的属性报ts错误问题。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;next-auth&quot;</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returned by `auth`, `useSession`, `getSession` and received as a prop on the `SessionProvider` React Context</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Session</span> &#123;</span><br><span class="line">    <span class="attr">user</span>: &#123;</span><br><span class="line">      <span class="attr">role</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">notion_token</span>: <span class="built_in">string</span>;</span><br><span class="line">    &#125; &amp; <span class="title class_">DefaultSession</span>[<span class="string">&quot;user&quot;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3-事件-events"><a href="#3-事件-events" class="headerlink" title="3.事件 events"></a>3.事件 events</h2><p><code>auth.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">events</span>: &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">linkAccount</span>(<span class="params">&#123; user &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (user.<span class="property">id</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">setEmailVerified</span>(user.<span class="property">id</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>一个用户（user）可连接多个account（由github、notion等提供的第三方OAuth账号），可设置当连接用户时，将用户设置为邮箱已验证（通过github、notion等可靠app登录的用户无需二次验证邮箱。）</p>
<h2 id="4-页面"><a href="#4-页面" class="headerlink" title="4.页面"></a>4.页面</h2><p><code>auth.ts</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pages: &#123;</span><br><span class="line">  signIn: &quot;/auth/login&quot;,</span><br><span class="line">  error: &quot;/auth/error&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>指定登录页、自定义鉴权出错页。</p>
<h2 id="5-登出"><a href="#5-登出" class="headerlink" title="5.登出"></a>5.登出</h2><p><code>action/logout.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use server&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; signOut &#125; <span class="keyword">from</span> <span class="string">&quot;@/auth&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">logout</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//  Some server stuff</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">signOut</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在客户端组件中使用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; logout &#125; <span class="keyword">from</span> <span class="string">&quot;@/actions/logout&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onClickSignOut</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">logout</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-使用Session获取用户信息"><a href="#6-使用Session获取用户信息" class="headerlink" title="6.使用Session获取用户信息"></a>6.使用Session获取用户信息</h2><p>在客户端调用useSession(),需要在SessionProvider的包裹下使用。</p>
<p><code>(protected)/layout.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Suspense</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SessionProvider</span> &#125; <span class="keyword">from</span> <span class="string">&quot;next-auth/react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">DashboardLayout</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  children, // will be a page or nested layout</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">SessionProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>     </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">SessionProvider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useSession &#125; <span class="keyword">from</span> <span class="string">&quot;next-auth/react&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> session = <span class="title function_">useSession</span>();</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>NextAuth能帮助你快速集成第三方登录，也支持灵活的自定义账号、密码登录。</p>
<p>借助ORM框架和一些中间件，一个NextJS项目已可以完成所有业务功能，不需要再有独立的后端服务。对于小而美的项目，是一个快速落地的理想选择。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于我</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Intro"><span class="toc-number">1.</span> <span class="toc-text">Intro</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.1.</span> <span class="toc-text">技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">背景知识学习</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.</span> <span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">代码框架搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Credentials"><span class="toc-number">3.</span> <span class="toc-text">Credentials</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">1.基础配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">2.注册页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="toc-number">3.3.</span> <span class="toc-text">3.用户登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Github-Provider"><span class="toc-number">4.</span> <span class="toc-text">Github Provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%96%B0%E5%BB%BAGithub-Oauth-App"><span class="toc-number">4.1.</span> <span class="toc-text">1. 新建Github Oauth App</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AEGithub-Provider"><span class="toc-number">4.2.</span> <span class="toc-text">2. 配置Github Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A1%B5%E9%9D%A2%E8%A7%A6%E5%8F%91Github%E7%99%BB%E5%BD%95"><span class="toc-number">4.3.</span> <span class="toc-text">3.页面触发Github登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Notion-Provider"><span class="toc-number">5.</span> <span class="toc-text">Notion Provider</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AEPublic-Ingegration"><span class="toc-number">5.1.</span> <span class="toc-text">1. 配置Public Ingegration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AENotion-Provider"><span class="toc-number">5.2.</span> <span class="toc-text">2. 配置Notion Provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Notion%E7%99%BB%E5%BD%95"><span class="toc-number">5.3.</span> <span class="toc-text">使用Notion登录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Convex-Adapter"><span class="toc-number">6.</span> <span class="toc-text">Convex Adapter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD"><span class="toc-number">7.</span> <span class="toc-text">其他功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9B%9E%E8%B0%83-callbacks"><span class="toc-number">7.1.</span> <span class="toc-text">1.回调 callbacks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89Session%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.2.</span> <span class="toc-text">2.自定义Session类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BA%8B%E4%BB%B6-events"><span class="toc-number">7.3.</span> <span class="toc-text">3.事件 events</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%A1%B5%E9%9D%A2"><span class="toc-number">7.4.</span> <span class="toc-text">4.页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%99%BB%E5%87%BA"><span class="toc-number">7.5.</span> <span class="toc-text">5.登出</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BD%BF%E7%94%A8Session%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">7.6.</span> <span class="toc-text">6.使用Session获取用户信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&text=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&is_video=false&description=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成&body=Check out this article: http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&title=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&name=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/06/12/%E8%AF%A6%E8%A7%A3Next%20Auth%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E7%AE%B1%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E3%80%81Github%E3%80%81Notion%E6%8E%88%E6%9D%83%20&amp;%20Convex%E9%9B%86%E6%88%90/&t=详解Next Auth：自定义邮箱密码登录注册、Github、Notion授权 &amp; Convex集成"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Ygria
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于我</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
